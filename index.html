
<style type="text/css">
	canvas {
		outline: none;
		border: 2px solid #000;
	}
</style>
<canvas id="canvas" width="400" height="400"></canvas>
<script src="processing-1.4.1.js"></script>
<script>
window.onload = function() {
	var sketch = new Processing("canvas");

	with(sketch) {

	var BREED = 0.05;
	var ATTRACTOR_RADIUS = 80;

	var directions = [
		{ x: -1, y: -1 },
		{ x: 0, y: -1 },
		{ x: 1, y: -1 },
		
		{ x: -1, y: 0 },
		//{ x: 0, y: 0 },
		{ x: 1, y: 0 },
		
		{ x: -1, y: 1 },
		{ x: 0, y: 1 },
		{ x: 1, y: 1 }
	];

	var overlap = {
		atPos: function(x, y) {
			return this[x + ":" + y];
		}
	};
	var agents = [];
	var attractors = [];

	var addAgent = function(color, x, y) {
		var agent = new Agent(color, x, y);
		agents.push(agent);
	};

	var Agent = function(color, x, y) {
		this.color = color;
		this.x = x;
		this.y = y;
	};

	Agent.prototype = {
		move: function() {
			// Add in attactor weights

			var originalX = this.x;
			var originalY = this.y;

			delete overlap[this.location()];

			var dir = this.attract();
			//floor(random(directions.length));
			//dir = directions[dir];

			this.x += dir.x;
			this.y += dir.y;

			if (this.x < 0) {
				this.x += width;
			} else if (this.x > width) {
				this.x -= width;
			}

			if (this.y < 0) {
				this.y += height;
			} else if (this.y > height) {
				this.y -= height;
			}

			var atOverlap = overlap[this.location()];

			if (atOverlap) {
				// Handle Collision
				this.collision(atOverlap);
				this.x = originalX;
				this.y = originalY;
			}

			overlap[this.location()] = this;
		},

		attract: function() {
			var weights = [1, 1, 1, 1, 1, 1, 1, 1];
			var agent = this;

			attractors.forEach(function(attractor) {
				if (attractor.color === agent.color) {
					var dist_agent = dist(agent.x, agent.y, attractor.x, attractor.y);
					if (dist_agent < ATTRACTOR_RADIUS) {
						var diffX = attractor.x - agent.x;
						var diffY = attractor.y - agent.y;
						var weight = ATTRACTOR_RADIUS * 10;
						var xWeight = (ATTRACTOR_RADIUS - diffX) / weight;
						var yWeight = (ATTRACTOR_RADIUS - diffY) / weight;
						
						if (diffX > 0) {
							weights[2] += xWeight;
							weights[4] += xWeight;
							weights[7] += xWeight;
						} else if (diffX < 0) {
							weights[0] += xWeight;
							weights[3] += xWeight;
							weights[5] += xWeight;
						}
						
						if (diffY > 0) {
							weights[5] += yWeight;
							weights[6] += yWeight;
							weights[7] += yWeight;
						} else if (diffY < 0) {
							weights[0] += yWeight;
							weights[1] += yWeight;
							weights[2] += yWeight;
						}
					}
				}
			});

			var totalWeight = 0;

			weights.forEach(function(weight) {
				totalWeight += weight;
			});

			var cutoff = random(totalWeight);
			var sumWeight = 0;
			var dir;
			
			for (var i = 0; i < weights.length; i++) {
				sumWeight += weights[i];
				
				if (cutoff < sumWeight) {
					dir = i;
					break;
				}
			}
			
			return directions[dir];
		},

		collision: function(other) {
			if (other.color === this.color) {
				// Breed!
				if (random(1) < BREED) {
					this.breed();
				}
			}
		},

		breed: function() {

			var dir = directions[floor(random(directions.length))];
			var childX = this.x + dir.x;
			var childY = this.y + dir.y
			//console.log("Breed??", this.x, this.y, childX, childY, overlap.atPos(childX, childY));
			if (!overlap.atPos(childX, childY)) {
				//console.log("BREEEEEEDDDD");
				addAgent(color(255, 0, 0), childX, childY);
			}
		},

		draw: function() {
			noStroke();
			fill(this.color);
			rect(this.x, this.y, 2, 2);
		},

		location: function() {
			return this.x + ":" + this.y;
		}
	};

	var addAttractor = function(color, x, y, strength) {
		var attractor = new Attractor(color, x, y, strength);
		attractors.push(attractor);
	};

	var Attractor = function(color, x, y, strength) {
		this.color = color;
		this.x = x;
		this.y = y;
		this.strength = strength;
	};

	Attractor.prototype = {
		draw: function() {
			stroke(0, 0, 0);
			fill(this.color, 0.1);
			ellipse(this.x, this.y, ATTRACTOR_RADIUS, ATTRACTOR_RADIUS);
			fill(this.color);
			ellipse(this.x, this.y, 8, 8);
		},
	};

	size(400, 400);

	addAttractor(color(0, 0, 0), 200, 200);
	addAttractor(color(0, 0, 0), 200, 160);

	draw = function() {
		background(255, 255, 255);

		attractors.forEach(function(attractor) {
			attractor.draw();
		});

		agents.forEach(function(agent) {
			agent.move();
			agent.draw();
		});
	};

	mousePressed = function() {
		addAgent(color(0, 0, 0), mouseX, mouseY);
	};

	sketch.loop();
}
};
</script>